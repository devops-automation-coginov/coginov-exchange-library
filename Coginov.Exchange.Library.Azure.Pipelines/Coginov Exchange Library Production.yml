# Variable 'buildNumber' was defined in the Variables tab
trigger:
  branches:
    include:
    - refs/heads/main
resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/main
jobs:
- job: Job_1
  displayName: Agent job 1
  pool:
    vmImage: windows-latest
  steps:
  - checkout: self
    clean: true
    fetchTags: false
  - task: NuGetToolInstaller@1
    displayName: Install Version NuGet 6.1.0
    inputs:
      versionSpec: 6.1.0
  - task: NuGetCommand@2
    displayName: NuGet restore
  - task: PowerShell@2
    displayName: Get Version From File in Gitlab
    inputs:
      filePath: Coginov.Exchange.Library.Azure.Pipelines/getversionfromfileprod.ps1
      script: ''
  - task: VSBuild@1
    displayName: Build Coginov Exchange Library
    inputs:
      msbuildArgs: /p:Version=$(buildNumber)
  - task: AzureKeyVault@2
    displayName: Get Certificate From Azure Key Vault
    inputs:
      ConnectedServiceName: 1104378e-5433-4211-b3f5-20649eda50e5
      KeyVaultName: kv-dev-canadaeast
  - task: PowerShell@2
    displayName: Sign Coginov Exchange Library
    inputs:
      filePath: Coginov.Exchange.Library.Azure.Pipelines/signcoginovexchangelibrary.ps1
      arguments: -ArtefactFolder "$(System.DefaultWorkingDirectory)" -base64 "$(CoginovCodeSigining)"
      script: ''
  - task: NuGetCommand@2
    displayName: NuGet pack for Coginov Exchange Library
    inputs:
      command: pack
      versioningScheme: byEnvVar
      versionEnvVar: buildNumber
      packTimezone: local
  - task: PublishBuildArtifacts@1
    displayName: Publish Nuget  Package of Coginov Exchange Library in Local Repository
  - task: NuGetCommand@2
    displayName: NuGet push
    inputs:
      command: push
      searchPatternPush: $(Build.ArtifactStagingDirectory)/*.nupkg
      feedPublish: 03f872cd-d7c9-4c7c-a4db-45bf005bf779
...
